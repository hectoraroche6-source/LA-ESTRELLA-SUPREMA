<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LA ESTRELLA SUPREMA | GLOBAL</title>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
body{font-family:Segoe UI;margin:0;background:#f4f4f4}
.hidden{display:none!important}
.container{max-width:1100px;margin:auto;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px}
.card{background:white;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.1);overflow:hidden}
.card img{width:100%;height:140px;object-fit:cover}
.card-body{padding:10px;text-align:center}
.add-btn{width:100%;padding:8px;background:#2e4d23;color:white;border:none;border-radius:8px}
.cat-btn{padding:8px 15px;border:none;border-radius:20px;background:#eee;margin-right:5px}
.cat-btn.active{background:#2e4d23;color:white}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center}
.modal-content{background:white;width:95%;max-width:500px;padding:20px;border-radius:15px;max-height:90vh;overflow:auto}
.btn-main{padding:10px;background:#2e4d23;color:white;border:none;border-radius:10px;width:100%}
.item-row{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
.btn-delete{background:red;color:white;border:none;padding:4px 8px;border-radius:5px}
</style>
</head>
<body>

<section id="portada" style="height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#2e4d23;color:white;text-align:center">
<h1>LA ESTRELLA SUPREMA</h1>
<button onclick="enterShop()" class="btn-main" style="width:auto;padding:15px 40px;margin-top:20px">ENTRAR</button>
</section>

<section id="tienda" class="hidden">
<div class="container">
<div onclick="adminLogin()" style="position:absolute;top:10px;right:10px;width:30px;height:30px;opacity:0.1;background:black;border-radius:50%"></div>

<input type="text" id="search" placeholder="Buscar..." onkeyup="renderShop()" style="width:100%;padding:10px;margin-bottom:10px">

<div id="cat-bar"></div>
<div id="grid-products" class="grid"></div>
</div>
</section>

<div id="modal-admin" class="modal hidden">
<div class="modal-content">
<h2>Panel Admin</h2>

<h4>Nuevo Producto</h4>
<input id="new-p-name" placeholder="Nombre">
<input id="new-p-price" type="number" placeholder="Precio">
<select id="new-p-cat"></select>
<input type="file" id="new-p-img">
<button onclick="saveToCloudProd()" class="btn-main">GUARDAR</button>

<hr>

<h4>Nueva Categor√≠a</h4>
<input id="new-c-name" placeholder="Nombre categor√≠a">
<button onclick="addCategory()" class="btn-main">CREAR</button>

<hr>

<h4>Productos</h4>
<div id="adm-list-prod"></div>

<h4>Categor√≠as</h4>
<div id="adm-list-cat"></div>

<button onclick="closeAdmin()" style="margin-top:15px;width:100%">Cerrar</button>
</div>
</div>

<script>
// ---------------- CONFIG FIREBASE ----------------
const firebaseConfig = {
apiKey:"AIzaSyCJbDPG-EC19g7ifX4SKF85uAsOF0ODHSo",
authDomain:"la-estrella-suprema.firebaseapp.com",
databaseURL:"https://la-estrella-suprema-default-rtdb.firebaseio.com",
projectId:"la-estrella-suprema",
storageBucket:"la-estrella-suprema.firebasestorage.app",
messagingSenderId:"246077605279",
appId:"1:246077605279:web:9b0556eab180f38f2369aa"
};

firebase.initializeApp(firebaseConfig);

// üî• REFERENCIAS POR SEPARADO
const dbRoot = firebase.database().ref('tienda_global');
const dbItems = dbRoot.child('items');
const dbCats = dbRoot.child('cats');

let appData = {items:[],cats:["COMBOS"]};
let currentCat="TODOS";

// ---------------- SINCRONIZACI√ìN ----------------
dbRoot.on('value', snap=>{
const data = snap.val();

if(data){
appData.items = data.items ? Object.values(data.items) : [];
appData.cats = data.cats || ["COMBOS"];
}else{
dbRoot.set({items:[],cats:["COMBOS"]});
}

updateUI();
});

// ---------------- UI ----------------
function enterShop(){
document.getElementById("portada").classList.add("hidden");
document.getElementById("tienda").classList.remove("hidden");
}

function updateUI(){
const catBar=document.getElementById("cat-bar");
let html=`<button class="cat-btn ${currentCat==="TODOS"?"active":""}" onclick="filterCat('TODOS')">TODOS</button>`;
appData.cats.forEach(c=>{
html+=`<button class="cat-btn ${currentCat===c?"active":""}" onclick="filterCat('${c}')">${c}</button>`;
});
catBar.innerHTML=html;

document.getElementById("new-p-cat").innerHTML=appData.cats.map(c=>`<option>${c}</option>`).join("");

renderShop();
renderAdminLists();
}

function filterCat(cat){
currentCat=cat;
updateUI();
}

function renderShop(){
const grid=document.getElementById("grid-products");
const term=document.getElementById("search").value.toLowerCase();
grid.innerHTML="";

const filtered=appData.items.filter(i=>{
return (currentCat==="TODOS"||i.cat===currentCat)&&i.name.toLowerCase().includes(term);
});

filtered.forEach(p=>{
grid.innerHTML+=`
<div class="card">
<img src="${p.img}">
<div class="card-body">
<b>${p.name}</b><br>
$${p.price} CUP
<button class="add-btn">Ver</button>
</div>
</div>`;
});
}

// ---------------- ADMIN ----------------
function adminLogin(){
const u=prompt("Usuario:");
const p=prompt("Contrase√±a:");
if(u==="H√âCTOR"&&p==="VIRTUS123VIRTUS"){
document.getElementById("modal-admin").classList.remove("hidden");
}else alert("Acceso denegado");
}

function closeAdmin(){
document.getElementById("modal-admin").classList.add("hidden");
}

// ‚úÖ GUARDAR PRODUCTO BIEN
function saveToCloudProd(){
const name=document.getElementById("new-p-name").value;
const price=document.getElementById("new-p-price").value;
const cat=document.getElementById("new-p-cat").value;
const file=document.getElementById("new-p-img").files[0];

if(!name||!price)return alert("Faltan datos");

const save=(img)=>{
dbItems.push({
id:Date.now(),
name:name,
price:parseFloat(price),
cat:cat,
img:img
}).then(()=>{
alert("Producto guardado");
document.getElementById("new-p-name").value="";
document.getElementById("new-p-price").value="";
});
};

if(file){
const reader=new FileReader();
reader.onload=e=>save(e.target.result);
reader.readAsDataURL(file);
}else{
save("https://via.placeholder.com/150");
}
}

// ‚úÖ CATEGOR√çA SEGURA
function addCategory(){
const name=document.getElementById("new-c-name").value.toUpperCase();
if(!name)return;

dbCats.once('value',snap=>{
let cats=snap.val()||[];
if(!cats.includes(name)){
cats.push(name);
dbCats.set(cats);
}
});
document.getElementById("new-c-name").value="";
}

// ‚úÖ BORRAR PRODUCTO CORRECTAMENTE
function deleteProd(index){
dbItems.once('value',snap=>{
const data=snap.val();
if(!data)return;
const keys=Object.keys(data);
firebase.database().ref('tienda_global/items/'+keys[index]).remove();
});
}

function deleteCat(index){
dbCats.once('value',snap=>{
let cats=snap.val()||[];
cats.splice(index,1);
dbCats.set(cats);
});
}

function renderAdminLists(){
const listP=document.getElementById("adm-list-prod");
const listC=document.getElementById("adm-list-cat");

listP.innerHTML="";
appData.items.forEach((p,i)=>{
listP.innerHTML+=`<div class="item-row">${p.name} <button class="btn-delete" onclick="deleteProd(${i})">X</button></div>`;
});

listC.innerHTML="";
appData.cats.forEach((c,i)=>{
listC.innerHTML+=`<div class="item-row">${c} <button class="btn-delete" onclick="deleteCat(${i})">X</button></div>`;
});
}

</script>
</body>
</html>
